---
title: "C3.ai data sampling notebook (Multi-variate Methods)"
output: html_notebook
---

# C3.ai COVID-19 Data Lake - Data Sampling (Multi-variate Methods)

This notebooks collects all available data for the Quantum-like Bayesian network interface.

For the time being, we are using a simplified model in which only the data segment but not the header segment will be created for event types.

To view an outline of this notebook, use the RStudio keyboard shortcut Control + Shift + O on Windows or Command + Shift + O on Mac.

Remark: Some of the packages may not be needed, use the following (sample) code to load packages instead:

#define a function to install and load required packages
ipak <- function(pkg){
  new.pkg <- pkg[!(pkg %in% installed.packages()[, "Package"])]
  if (length(new.pkg)) 
    install.packages(new.pkg, dependencies = TRUE)
  sapply(pkg, require, character.only = TRUE)
}

#specify a list of required packages
pack_list <- c("dplyr",
               "lubridate",
               "NCmisc")

#install and load packages
suppressWarnings(ipak(pack_list))

#define current working directory
current_wd <- dirname(rstudioapi::getActiveDocumentContext()$path)
setwd(current_wd)

#cross-check unused packages
used_packages <- list.functions.in.file(rstudioapi::getSourceEditorContext()$path) %>%
  names() %>%
  unique()
pack_list <- paste0("package:",unlist(pack_list))
print("Unused packages:")
print(setdiff(pack_list,used_packages))
print("Missing packages:")
print(setdiff(used_packages,pack_list))

```{r}
if (!require(plyr)) install.packages('plyr')
if (!require(dplyr)) install.packages('dplyr')
if (!require(pbmcapply)) install.packages('pbmcapply')
if (!require(stats)) install.packages('stats')
if (!require(lubridate)) install.packages('lubridate')
if (!require(fuzzyjoin)) install.packages('fuzzyjoin')
if (!require(gtools)) install.packages('gtools')
if (!require(tidyr)) install.packages('tidyr')
if (!require(stringr)) install.packages('stringr')
if (!require(uuid)) install.packages('uuid')
if (!require(data.table)) install.packages('data.table')
if (!require(rlist)) install.packages('rlist')
if (!require(ggplot2)) install.packages('ggplot2')

library(plyr)
library(dplyr)
library(pbmcapply)
library(stats)
library(lubridate)
library(fuzzyjoin)
library(gtools)
library(tidyr)
library(stringr)
library(uuid)
library(data.table)
library(rlist)
library(ggplot2)
```

Define maximum data validity

```{r}
seconds_back <- 6*60*60-1
seconds_ahead <- 6*60*60-1
```


Function to collect all data

```{r}
start_time <- as.character(Sys.time())

#get existing scope for sampling
object_types <- read.csv(file="../events/objectTypeIDs.csv",
                         header=TRUE,
                         sep=";")
measures <- read.csv(file="../events/measureIDs.csv",
                         header=TRUE,
                         sep=";") %>%
              mutate(.,
                     uuidMeasure=uuidMeasure,
                     description=paste0(source,
                                        "_",
                                        description,
                                        "_",
                                        scaleLevel),
                     number=seq(1,nrow(.)),
                     .keep="none")
objects <- read.csv(file="../events/objectIDs.csv",
                         header=TRUE,
                         sep=";") %>%
             select(.,
                    -iso) %>%
             left_join(.,
                       object_types,
                       by="uuidObjectType") %>%
             mutate(.,
                    description=paste0(description.y,
                                       "_",
                                       description.x),
                    number=seq(1,nrow(.)),
                    .keep="unused")
valid_records <- expand.grid(measures$number,
                             objects$number) %>%
                   left_join(.,
                             measures,
                             by=c("Var1"="number")) %>%
                   left_join(.,
                             objects,
                             by=c("Var2"="number")) %>%
                   select(.,
                          -c(Var1,
                             Var2)) %>%
                   mutate(.,
                          eventType=paste0(uuidObjectType,
                                           "_",
                                           uuidMeasure))

#cross-check list against existing files
existing_files <- list.files(path="../events/") %>%
                    substr(.,
                           1,
                           nchar(.)-4)
valid_records <- valid_records[which(valid_records$eventType %in% existing_files),]
valid_records$number <- seq(1,
                            nrow(valid_records))
files <- unique(valid_records$eventType)

#get existing validity periods
timestamps <- pbmclapply(files,FUN=function(x) {
                           load(paste0("../events/",
                                       x,
                                       ".rda"))
                           data <- mutate(data,
                                          measurementTime=with_tz(data$measurementTime,
                                                                  tzone="UTC"))
                           return(as.character(data$measurementTime))
              },mc.cores=8L) %>%
                unlist() %>%
                unique()
timestamps <- interval(timestamps,
                       timestamps)
int_start(timestamps) <- int_start(timestamps) - seconds_back
int_end(timestamps) <- int_end(timestamps) + seconds_ahead
timestamps <- data.frame(validity=timestamps,
                         number=seq(1,
                                    length(timestamps)))

#re-calculate valid records
valid_records <- expand.grid(valid_records$number,
                             timestamps$number) %>%
                   left_join(.,
                             valid_records,
                             by=c("Var1"="number")) %>%
                   left_join(.,
                             timestamps,
                             by=c("Var2"="number")) %>%
                   select(.,
                          -c(Var1,
                             Var2)) %>%
                   select(.,
                          eventType,
                          uuidMeasure,
                          uuidObject,
                          validity) %>%
                   dlply(.,
                         "eventType")

#load required event records
event_records <- pbmclapply(1:length(valid_records),FUN=function(x) {
                   load(paste0("../events/",
                               names(valid_records[x]),
                               ".rda"))
                   data <- mutate(data,
                                  measurementTime=with_tz(data$measurementTime,
                                                          tzone="UTC")) %>%
                             left_join(valid_records[[x]],
                                       data,
                                       by="uuidObject") %>%
                             .[which(.$measurementTime %within% .$validity),] %>%
                             select(.,
                                    uuidMeasure,
                                    uuidObject,
                                    validity,
                                    measurementValue) %>%
                             mutate(.,
                                    validity=as.character(validity))
                   return(data)
                 },mc.cores=8L)

end_time <- as.character(Sys.time())

names(event_records) <- names(valid_records)
event_records <- event_records %>%
                   ldply(.parallel=TRUE,
                         .id="eventType") %>%
                   mutate(.,
                          uuidObjectType=substr(eventType,
                                            1,
                                            36),
                          measurementValue=as.numeric(measurementValue),
                          .keep="unused") %>%
                   left_join(.,
                             objects,
                             by=c("uuidObjectType",
                                  "uuidObject")) %>%
                   select(.,
                          -c(uuidObjectType,
                             uuidObject,
                             number)) %>%
                   left_join(.,
                             measures,
                             by="uuidMeasure") %>%
                   select(.,
                          -c(uuidMeasure,
                             number)) %>%
                   mutate(.,
                          object=description.x,
                          validity=validity,
                          measure=description.y,
                          measurementValue=measurementValue,
                          .keep="none") %>%
                   distinct(.,
                            object,
                            validity,
                            measure,
                            .keep_all=TRUE) %>%
                   pivot_wider(.,
                               names_from=measure,
                               values_from=measurementValue,
                               values_fill=NA)

write.table(event_records,
            file=paste0("event_records_",
                        start_time,
                        "_",
                        end_time,
                        ".csv"),
            append=FALSE,
            quote=FALSE,
            sep=";",
            row.names=FALSE,
            col.names=TRUE)
```

Calculate sample models

```{r}
#impact of German PM party affiliation on transit mobility, using reproduction number
model_data <- event_records %>%
                filter(.,
                       str_detect(object,
                                  regex("^state_de_"))) %>%
                select(.,
                       cep_repronum_numeric,
                       leader_party_nominal,
                       c3_Google_TransitStationsMobility_index) %>%
                .[which(complete.cases(.)),]
model_data[which(model_data$leader_party_nominal>1),]$leader_party_nominal <- 0

model <- lm(c3_Google_TransitStationsMobility_index ~.,
            data=model_data)
summary(model)
plot()

#impact of US governor party affiliation on transit mobility, using reproduction number
model_data <- event_records %>%
                filter(.,
                       str_detect(object,
                                  regex("^state_us_"))) %>%
                select(.,
                       cep_repronum_numeric,
                       leader_party_nominal,
                       c3_Google_TransitStationsMobility_index) %>%
                .[which(complete.cases(.)),]
model_data[which(model_data$leader_party_nominal>1),]$leader_party_nominal <- 0

model <- lm(c3_Google_TransitStationsMobility_index ~.,
            data=model_data)
summary(model)

#impact of German PM gender on transit mobility, using reproduction number
model_data <- event_records %>%
                filter(.,
                       str_detect(object,
                                  regex("^state_de_"))) %>%
                select(.,
                       cep_repronum_numeric,
                       leader_gender_nominal,
                       c3_Google_TransitStationsMobility_index) %>%
                .[which(complete.cases(.)),]
model_data[which(model_data$leader_gender_nominal>1),]$leader_gender_nominal <- 0

model <- lm(c3_Google_TransitStationsMobility_index ~.,
            data=model_data)
summary(model)

#impact of US governor gender on transit mobility, using reproduction number
model_data <- event_records %>%
                filter(.,
                       str_detect(object,
                                  regex("^state_us_"))) %>%
                select(.,
                       cep_repronum_numeric,
                       leader_gender_nominal,
                       c3_Google_TransitStationsMobility_index) %>%
                .[which(complete.cases(.)),]
model_data[which(model_data$leader_gender_nominal>1),]$leader_gender_nominal <- 0

model <- lm(c3_Google_TransitStationsMobility_index ~.,
            data=model_data)
summary(model)
```

